<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Pressure COâ‚‚</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<style>
body{font-family:Poppins;background:#f4f4f4;padding:30px}
.chart-container{width:80%;margin:auto;background:#fff;padding:20px;border-radius:20px}
.back-btn{display:inline-block;margin:10px 0 20px 10%;padding:10px 18px;background:#2D6A4F;color:#fff;text-decoration:none;border-radius:8px;font-weight:600}

#suggestion{
  display:none;width:80%;margin:20px auto;padding:15px;
  border-radius:12px;text-align:center;font-weight:600
}

#machine-alert{
  display:none;width:80%;margin:15px auto;padding:15px;
  border-radius:12px;font-weight:600;
  background:#ffe5e5;border:2px solid red;color:#b00020
}
</style>
</head>

<body>

<a class="back-btn" href="index.html">â¬… Back</a>
<h2 align="center">Pressure Process â€“ COâ‚‚ Emission (mg)</h2>

<div id="suggestion"></div>
<div id="machine-alert"></div>

<div class="chart-container">
  <canvas id="chart"></canvas>
</div>

<script>
Chart.register(window['chartjs-plugin-annotation']);

/* ========== CONFIG ========== */
const CHANNEL_ID="3204458";
const READ_API_KEY="KAH4AJHZ9UA48ZRJ";
const FIELD="field4";     // ðŸ”´ pressure COâ‚‚
const SAFE=1;             // mg
const WARNING=5;          // mg (RED limit)

/* ========== UI HELPERS ========== */
function show(level,msg){
  const b=document.getElementById("suggestion");
  b.style.display="block";
  b.style.background=level==="red"?"#ffe5e5":level==="yellow"?"#fff4cc":"#e6f4ea";
  b.style.border="2px solid "+(level==="red"?"red":level==="yellow"?"orange":"green");
  b.style.color=level==="red"?"#b00020":level==="yellow"?"#8a6d00":"#1e7e34";
  b.innerText=msg;
}

function showMachineAlert(msg){
  const box=document.getElementById("machine-alert");
  box.style.display="block";
  box.innerHTML=msg;
}

function hideMachineAlert(){
  document.getElementById("machine-alert").style.display="none";
}

/* ========== CHART ========== */
const chart=new Chart(document.getElementById("chart"),{
 type:"line",
 data:{labels:[],datasets:[
  {
   label:"Pressure COâ‚‚ (mg)",
   data:[],
   borderColor:"green",
   borderWidth:3,
   tension:.35,
   pointRadius:3,
   pointHoverRadius:6
  },
  {
   label:"Average",
   data:[],
   borderDash:[5,5],
   borderColor:"blue",
   pointRadius:0
  },
  {
   label:"Peak",
   data:[],
   borderDash:[2,2],
   borderColor:"purple",
   pointRadius:0
  }
 ]},
 options:{
  scales:{y:{beginAtZero:true,title:{display:true,text:"mg COâ‚‚"}}},
  plugins:{annotation:{annotations:{
   green:{type:"box",yMin:0,yMax:SAFE,backgroundColor:"rgba(0,200,0,.12)"},
   yellow:{type:"box",yMin:SAFE,yMax:WARNING,backgroundColor:"rgba(255,165,0,.12)"},
   red:{type:"box",yMin:WARNING,yMax:"max",backgroundColor:"rgba(255,0,0,.12)"}
  }}}
 }
});

/* ========== DATA UPDATE ========== */
async function update(){
 const res=await fetch(
   `https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/4.json?api_key=${READ_API_KEY}&results=60`
 );
 const j=await res.json();
 const f=j.feeds||[];

 const v=f.map(x=>parseFloat(x[FIELD])*1_000_000||0);
 const t=f.map(x=>new Date(x.created_at).toLocaleTimeString());

 if(!v.length) return;

 const avg=v.reduce((a,b)=>a+b,0)/v.length;
 const peak=Math.max(...v);

 /* ----- STATUS MESSAGE ----- */
 if(peak>WARNING) show("red","âš  High pressure-related emission detected");
 else if(peak>SAFE) show("yellow","âš  Pressure emission above normal");
 else show("green","âœ… Pressure system operating normally");

 /* ----- MACHINE DIAGNOSTIC ----- */
 if(peak>WARNING){
   showMachineAlert(`
     ðŸ”´ <b>Possible Causes â€“ Check These Pressure System Components:</b><br><br>
     âœ” Leaks in pipes or joints<br>
     âœ” Faulty pressure valves or regulators<br>
     âœ” Worn seals or gaskets<br>
     âœ” Compressor inefficiency or overload<br>
     âœ” Blocked exhaust or relief paths
   `);
 } else {
   hideMachineAlert();
 }

 chart.data.labels=t;
 chart.data.datasets[0].data=v;
 chart.data.datasets[1].data=v.map(()=>avg);
 chart.data.datasets[2].data=v.map(()=>peak);
 chart.options.scales.y.max=Math.max(peak*2,1);

 chart.update();
}

update();
setInterval(update,60000);
</script>
</body>
</html>
